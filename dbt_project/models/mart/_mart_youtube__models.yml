version: 2

models:
  - name: fct_video_performance
    description: Fact table for video-level performance analytics
    config:
      tags: ['mart', 'fact', 'incremental']
      materialized: table
      partition_by:
        field: published_date
        data_type: date
        granularity: month
      cluster_by:
        - channel_id
        - video_id
    columns:
      - name: video_id
        description: YouTube Video ID (primary key)
        tests:
          - unique
          - not_null
      - name: channel_id
        description: YouTube Channel ID
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_channel_summary')
                field: channel_id
      - name: published_date
        tests:
          - not_null
      - name: view_count
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
      - name: like_count
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
      - name: comment_count
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
      - name: engagement_score
        description: Weighted engagement score â€” NULL for videos published today (days_since_published = 0)
        tests:
          - dbt_utils.accepted_range:
              config:
                where: "engagement_score is not null"
              arguments:
                min_value: 0
      - name: like_rate_pct
        tests:
          - dbt_utils.accepted_range:
              config:
                where: "like_rate_pct is not null"
              arguments:
                min_value: 0
                max_value: 100
      - name: engagement_level
        tests:
          - accepted_values:
              config:
                where: "engagement_level is not null"
              arguments:
                values: ['high', 'medium', 'low']
      - name: video_length_category
        tests:
          - accepted_values:
              arguments:
                values: ['shorts', 'short', 'medium', 'long']
      - name: crawled_at
        tests:
          - not_null

  - name: dim_channel_summary
    description: Dimension table for channel-level analytics
    config:
      tags: ['mart', 'dimension']
      materialized: table
      cluster_by:
        - channel_id
    columns:
      - name: channel_id
        description: YouTube Channel ID (primary key)
        tests:
          - unique
          - not_null
      - name: channel_name
        tests:
          - not_null
      - name: total_videos_crawled
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1
      - name: total_views
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
      - name: avg_like_rate_pct
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                max_value: 100
      - name: channel_active_days
        tests:
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
      - name: views_per_subscriber
        tests:
          - dbt_utils.accepted_range:
              config:
                where: "views_per_subscriber is not null"
              arguments:
                min_value: 0

  - name: agg_daily_metrics
    description: Daily aggregated metrics per channel, grouped by video publish date
    config:
      tags: ['mart', 'aggregate', 'incremental']
      materialized: table
      partition_by:
        field: metric_date
        data_type: date
        granularity: month
      cluster_by:
        - channel_id
        - metric_date
    columns:
      - name: date_channel_key
        description: Surrogate key = hash(metric_date, channel_id)
        tests:
          - unique
          - not_null
      - name: metric_date
        tests:
          - not_null
      - name: channel_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_channel_summary')
                field: channel_id
      - name: videos_published
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1
      - name: total_views
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
      - name: avg_engagement_score
        tests:
          - dbt_utils.accepted_range:
              config:
                where: "avg_engagement_score is not null"
              arguments:
                min_value: 0
